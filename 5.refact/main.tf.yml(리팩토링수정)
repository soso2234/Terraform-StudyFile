# --------------------------------------------------------------------------------
# 1. 테라폼 및 프로바이더 설정
# --------------------------------------------------------------------------------
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "6.25.0"
    }
  }
}

provider "aws" {
  # 에러 해결을 위해 리전 설정을 명시하는 것이 좋습니다.
  region = "ap-northeast-2"
}

# --------------------------------------------------------------------------------
# 2. 변수 정의
# --------------------------------------------------------------------------------
variable "pjt_name" {
  type        = string
  description = "프로젝트 이름?"
  default     = "terraform"
}

# 서브넷 구성을 위한 변수 (for_each에 사용)
variable "subnet_configs" {
  type = map(object({
    cidr_block        = string
    availability_zone = string
    type              = string # "pub" 또는 "pri"
  }))
  default = {
    # Public Subnets
    pub_sn1 = { cidr_block = "172.16.1.0/24", availability_zone = "ap-northeast-2a", type = "pub" }
    pub_sn2 = { cidr_block = "172.16.2.0/24", availability_zone = "ap-northeast-2c", type = "pub" }
    # Private Subnets
    pri_sn3 = { cidr_block = "172.16.3.0/24", availability_zone = "ap-northeast-2a", type = "pri" }
    pri_sn4 = { cidr_block = "172.16.4.0/24", availability_zone = "ap-northeast-2c", type = "pri" }
  }
}

# --------------------------------------------------------------------------------
# 3. 네트워크 리소스 (VPC, IGW, Subnet, Route Table, NAT)
# --------------------------------------------------------------------------------

// VPC 생성
resource "aws_vpc" "tf_vpc" {
  cidr_block           = "172.16.0.0/16"
  enable_dns_support   = true
  enable_dns_hostnames = true

  tags = {
    Name = "${var.pjt_name}-vpc"
  }
}

// IGW 생성
resource "aws_internet_gateway" "tf_igw" {
  vpc_id = aws_vpc.tf_vpc.id
  tags = {
    Name = "${var.pjt_name}-igw"
  }
}

// 서브넷 생성 (for_each 사용)
resource "aws_subnet" "tf_subnets" {
  for_each          = var.subnet_configs
  vpc_id            = aws_vpc.tf_vpc.id
  cidr_block        = each.value.cidr_block
  availability_zone = each.value.availability_zone

  tags = {
    Name = "${var.pjt_name}-${each.key}"
    Type = each.value.type
  }
}

// 라우팅 테이블 생성 (for_each 사용: pub/pri 2개)
resource "aws_route_table" "tf_rts" {
  for_each = toset(["pub", "pri"])
  vpc_id   = aws_vpc.tf_vpc.id

  tags = {
    Name = "${var.pjt_name}-${each.key}-rt"
  }
}

// 퍼블릭 라우팅 테이블 경로 설정 (0.0.0.0/0 -> IGW)
resource "aws_route" "tf_pub_rt_route" {
  count                  = 1 # 1개만 생성
  route_table_id         = aws_route_table.tf_rts["pub"].id
  destination_cidr_block = "0.0.0.0/0"
  gateway_id             = aws_internet_gateway.tf_igw.id
}

// EIP 생성 (NAT Gateway용)
resource "aws_eip" "tf_nat_eip" {
  tags = {
    Name = "${var.pjt_name}-nat-eip"
  }
}

// NAT 게이트웨이 생성 (pub_sn1에 배치)
resource "aws_nat_gateway" "tf_nat_gw" {
  allocation_id = aws_eip.tf_nat_eip.id
  subnet_id     = aws_subnet.tf_subnets["pub_sn1"].id
  tags = {
    Name = "${var.pjt_name}-nat-gw"
  }
  depends_on = [aws_internet_gateway.tf_igw]
}

// 프라이빗 라우팅 테이블 경로 설정 (0.0.0.0/0 -> NAT Gateway)
resource "aws_route" "tf_pri_rt_route" {
  count                  = 1 # 1개만 생성
  route_table_id         = aws_route_table.tf_rts["pri"].id
  destination_cidr_block = "0.0.0.0/0"
  nat_gateway_id         = aws_nat_gateway.tf_nat_gw.id
  depends_on             = [aws_nat_gateway.tf_nat_gw]
}

// 라우팅 테이블과 서브넷 연결 (for_each 사용)
resource "aws_route_table_association" "tf_rt_associations" {
  for_each  = aws_subnet.tf_subnets # 4개 서브넷 모두 반복
  subnet_id = each.value.id
  # 서브넷의 "Type" 태그 값(pub/pri)을 사용하여 해당 라우팅 테이블에 연결
  route_table_id = aws_route_table.tf_rts[each.value.tags.Type].id
}

# --------------------------------------------------------------------------------
# 4. 보안 그룹 (EC2 및 ALB)
# --------------------------------------------------------------------------------

// EC2 웹서버 보안 그룹
resource "aws_security_group" "tf_ec2_sg" {
  name        = "tf_ec2_sg"
  description = "Allow SSH, HTTP for EC2"
  vpc_id      = aws_vpc.tf_vpc.id
  tags = {
    Name = "${var.pjt_name}-ec2-sg"
  }
}

// EC2 인바운드 규칙 (for_each 사용: SSH, HTTP)
resource "aws_vpc_security_group_ingress_rule" "tf_ec2_sg_ingress" {
  for_each          = { ssh = 22, http = 80 }
  security_group_id = aws_security_group.tf_ec2_sg.id
  cidr_ipv4         = "0.0.0.0/0"
  from_port         = each.value
  ip_protocol       = "tcp"
  to_port           = each.value
}

// EC2 아웃바운드 규칙 (전체 허용)
resource "aws_vpc_security_group_egress_rule" "tf_ec2_sg_egress" {
  security_group_id = aws_security_group.tf_ec2_sg.id
  cidr_ipv4         = "0.0.0.0/0"
  ip_protocol       = "-1"
}

// ALB 보안 그룹
resource "aws_security_group" "tf_alb_sg" {
  name        = "tf_alb_sg"
  description = "Allow HTTP, HTTPS for ALB"
  vpc_id      = aws_vpc.tf_vpc.id
  tags = {
    Name = "${var.pjt_name}-alb-sg"
  }
}

// ALB 인바운드 규칙 (for_each 사용: HTTP, HTTPS)
resource "aws_vpc_security_group_ingress_rule" "tf_alb_sg_ingress" {
  for_each          = { http = 80, https = 443 }
  security_group_id = aws_security_group.tf_alb_sg.id
  cidr_ipv4         = "0.0.0.0/0"
  from_port         = each.value
  ip_protocol       = "tcp"
  to_port           = each.value
}

// ALB 아웃바운드 규칙 (전체 허용)
resource "aws_vpc_security_group_egress_rule" "tf_alb_sg_egress" {
  security_group_id = aws_security_group.tf_alb_sg.id
  cidr_ipv4         = "0.0.0.0/0"
  ip_protocol       = "-1"
}

# --------------------------------------------------------------------------------
# 5. EC2 및 ALB
# --------------------------------------------------------------------------------

// EC2 인스턴스 생성 (count 사용: 2개)
resource "aws_instance" "tf_ec2" {
  count                       = 2 # 인스턴스 2개 생성
  ami                         = "ami-0b818a04bc9c2133c"
  instance_type               = "t3.micro"
  associate_public_ip_address = false
  vpc_security_group_ids      = [aws_security_group.tf_ec2_sg.id]
  key_name                    = "tf-key"
  depends_on                  = [aws_nat_gateway.tf_nat_gw]

  # Private Subnet 3, 4에 순차적으로 할당
  subnet_id = [
    aws_subnet.tf_subnets["pri_sn3"].id,
    aws_subnet.tf_subnets["pri_sn4"].id
  ][count.index]

  user_data = <<-EOT
    #!/bin/bash
    yum install -y httpd
    systemctl start httpd
    systemctl enable httpd
    echo "<h1>TEST Web Server ${count.index + 1}</h1>" > /var/www/html/index.html
    EOT

  tags = {
    Name = "${var.pjt_name}-ec2-${count.index + 1}"
  }
}

// 대상 그룹 생성
resource "aws_lb_target_group" "tf_tg" {
  name     = "tf-alb-tg"
  port     = 80
  protocol = "HTTP"
  vpc_id   = aws_vpc.tf_vpc.id
}

// 대상 그룹에 EC2 인스턴스 연결 (count 사용: 2개)
resource "aws_lb_target_group_attachment" "tf_tg_ec2_atts" {
  count            = length(aws_instance.tf_ec2) # EC2 인스턴스 개수만큼 반복
  target_group_arn = aws_lb_target_group.tf_tg.arn
  target_id        = aws_instance.tf_ec2[count.index].id
  port             = 80
  depends_on       = [aws_instance.tf_ec2]
}

// ALB 생성
resource "aws_lb" "tf_alb" {
  name               = "tf-alb"
  internal           = false
  load_balancer_type = "application"
  security_groups    = [aws_security_group.tf_alb_sg.id]
  # Public Subnet 1, 2에 할당
  subnets = [
    aws_subnet.tf_subnets["pub_sn1"].id,
    aws_subnet.tf_subnets["pub_sn2"].id
  ]
  enable_deletion_protection = false
  tags = {
    Name = "${var.pjt_name}_alb"
  }
}

// 리스너 생성 (HTTP:80 -> Target Group)
resource "aws_lb_listener" "tf_web_listener" {
  load_balancer_arn = aws_lb.tf_alb.arn
  port              = "80"
  protocol          = "HTTP"

  default_action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.tf_tg.arn
  }
}